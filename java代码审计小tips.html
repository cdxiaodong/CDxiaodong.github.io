<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="CDxiaodong"><meta name="keywords" content=""><meta name="description" content="审计1234561、找最新版的版本较低的，例如1.1、1.22、找github star不多的3、找源码总容量小的1、如果cms版本高，说明开发有经常维护，同时也说明里面的简单漏洞已经被发现并且被提交并整改了。（具体这个可以看看CMS官网放出的更新日志）2、为什么找github star不多的cms？很简单，使用的人不多，没人标星，功能也比较少。3、源码少容易看啊，而且想着源代码就那么点，看着也不"><meta property="og:type" content="article"><meta property="og:title" content="java代码审计小tips"><meta property="og:url" content="http://example.com/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B0%8Ftips.html"><meta property="og:site_name" content="CD_blog"><meta property="og:description" content="审计1234561、找最新版的版本较低的，例如1.1、1.22、找github star不多的3、找源码总容量小的1、如果cms版本高，说明开发有经常维护，同时也说明里面的简单漏洞已经被发现并且被提交并整改了。（具体这个可以看看CMS官网放出的更新日志）2、为什么找github star不多的cms？很简单，使用的人不多，没人标星，功能也比较少。3、源码少容易看啊，而且想着源代码就那么点，看着也不"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206011153860.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206011155165.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071436206.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071512538.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD/202206071510841.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071512699.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071513749.png"><meta property="og:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071521926.png"><meta property="article:published_time" content="2022-09-01T16:00:00.000Z"><meta property="article:modified_time" content="2023-02-20T10:31:34.000Z"><meta property="article:author" content="CDxiaodong"><meta property="article:tag" content="学习笔记"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206011153860.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>java代码审计小tips - CD_blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/mac.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"example.com",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"eJkDJodFGiDL0TVTWRwDW40Z-gzGzoHsz",app_key:"xhVxcHFbhAlnmT8nFUbU2ps7",server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>CD_blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="java代码审计小tips"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-09-02 00:00" pubdate>September 2, 2022 am</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 7.4k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 62 mins </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> views</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">java代码审计小tips</h1><div class="markdown-body"><h2 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>、找最新版的版本较低的，例如<span class="hljs-number">1</span>.<span class="hljs-number">1</span>、<span class="hljs-number">1</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">2</span>、找github star不多的<br><span class="hljs-attribute">3</span>、找源码总容量小的<br><span class="hljs-attribute">1</span>、如果cms版本高，说明开发有经常维护，同时也说明里面的简单漏洞已经被发现并且被提交并整改了。（具体这个可以看看CMS官网放出的更新日志）<br><span class="hljs-attribute">2</span>、为什么找github star不多的cms？很简单，使用的人不多，没人标星，功能也比较少。<br><span class="hljs-attribute">3</span>、源码少容易看啊，而且想着源代码就那么点，看着也不会太心累。<br></code></pre></td></tr></table></figure><p>-javaagent:G:\dongtai-agent.jar</p><p>接下来我要突破瓶颈了 不搞那些浅显的东西了 至于低级的东西这里也不会讲了</p><p>接下来我将会学习涵盖各种cc链 各种代码框架rce流程</p><p>各种骚姿势。各种内存码写法 各种利用方式。为了节约时间 那些基础的东西也不讲了</p><p>这里只有精华</p><p>1.combo</p><p>2.重点看这个文章里运</p><p>用了哪些技巧，比如如何绕过过滤、用了哪些偏门gadget。其次关注这个产品、这个组件它的整体框架逻辑是什么样的，他有哪些有趣的功能机制是可以拿来串联链。</p><p>3.我们可以忽略什么？繁琐的各种函数跟进，根本毫无意义，随便看看就行了，除非你也专门研究这个产品的0day挖掘那么你可以细致的看一看，如果你想用它来挖别的产品那么你可以直接忽略掉很多没有用的函数跟进，只看那些对数据有一定复杂过滤操作的典型函数就行了。</p><p>4.即使我不懂Go，我知道我需要找到什么、需要去串联什么，剩下的不过是百度百度看不懂的语法罢了。总之就是一句话：<strong>just do it</strong></p><p>-javaagent:G:\桌面文件夹\任务\第三阶段\作业二\审计框a架靶场\dongtai-agent.jar</p><p><img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206011153860.png" srcset="/img/loading.gif" lazyload alt="image-20220601115349651"><img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206011155165.png" srcset="/img/loading.gif" lazyload alt="image-20220601115521088"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs assembly">密码硬编码最容易找，直接用 Sublime Text 打开项目目录，然后按 Ctrl + Shift + F 进行全局 搜索 password key关键词：<br><br>反射型 XSS 一般 fortify 一般都能扫描出来<br><br>存储型 XSS 审计方法：方法有主要有两种： 1. 全局搜索数据库的插入语句(关键词：insert,save,update)，然后找到该插入语句所属的方 法名如(insertUser())，然后全局搜索该方法在哪里被调用，一层层的跟踪。直到 getParamter()或者getpara(有的工程师为了方便用的getpara)方法获取请求参数的地方停止，如果没有全局 XSS 过滤器，跟踪的整个流 程都没有对获取的参数过滤，则存在存储型 XSS。<br><br>\2. 从 getParameter 关键词开始 ，跟踪请求参数，直到插入数据库的语句，如果中间没有过 滤参数，则存在存储型 XSS。<br><br>SQL 注入一般 fortify 一般都能扫描出来 手动找的话，一般直接搜索 select、update、delete、insert 关键词就会有收获 如果 sql 语句中有出现+ append、 $（） getConnection连接数据库# 等字眼，如果没有配置 SQL 过滤文件，则判断存 在 SQL 注入漏洞<br>limit，orderby后面是不能预编译<br><br>当找到某个变量关键词有 SQL 注入漏洞时，还可以直接全局搜索那个关键词找出类似漏洞 的文件，<br><br> 任意文件下载 审计方法：全局搜索以下关键词 fileName filePath getFile getWriter<br><br>6 任意(越权)文件删除 审计方法：任意文件删除漏洞搜索以下关键词可以找到： delete, UserController   deleteFile,fileName ,filePath <br><br>文件上传 审计方法： 文件上传可以搜索以下关键词：（需注意有没有配置文件上传白名单） upload，write,fileName ,filePath 在查看时，主要判断是否有检查后缀名，同时要查看配置文件是否有设置白名单或者黑名单<br><br>命令注入 审计方法：可以搜索以下关键词： getRuntime,exec,cmd,shell<br><br>缓冲区溢出 审计方法：主要通过搜索关键词定位，再分析上下文 可搜索以下关键字： <br>strcpy,strcat,scanf,memcpy(md5memcpy不存在缓冲区溢出),memmove,memeccpy Getc(),fgetc(),getchar;read,printf<br><br>0XML 注入 审计方法： XML 解析一般在导入配置、数据传输接口等场景可能会用到，可通过搜索以下关键字定位： DocumentBuilder、XMLStreamReader、SAXBuilder、SAXParser、SAXReader 、XMLReader、 SAXSource 、TransformerFactory 、SAXTransformerFactory 、SchemaFactory 涉及到 XML 文件处理的场景可留意下 XML 解析器是否禁用外部实体，从而判断是否存在 XXE<br><br>日志记录敏感信息 审计方法： 通过搜索关键词 log.info logger.info 来进行定位 （怎么审计？）<br><br>URL跳转 审计方法：通过搜索以下关键词定位： sendRedirect、setHeader、forward 需注意有没有配置 url 跳转白名单<br><br>敏感信息泄露及错误处理 审计方法：查看配置文件是否配置统一错误页面(在pm.xml查找是否含有errorpage或者404.jsp 500.jsp等醒目代码)，如果有则不存在此漏洞，如果没有再通过 搜索以下关键词搜索定位, Getmessage、exception <br><br>反序列化漏洞 审计方法： Java 程序使用 ObjectInputStream 对象的 readObject 方法将反序列化数据转换为 java 对象。 但当输入的反序列化的数据可被用户控制，那么攻击者即可通过构造恶意输入，让反序列化 产生非预期的对象，在此过程中执行构造的任意代码。 反序列化操作一般在导入模版文件、网络通信、数据传输、日志格式化存储、对象数据落磁 盘或 DB 存储等业务场景,在代码审计时可重点关注一些反序列化操作函数并判断输入是否 可控，如下： ObjectInputStream.readObject ObjectInputStream.readUnshared XMLDecoder.readObject Yaml.load XStream.fromXML ObjectMapper.readValue JSON.parseObject<br><br>不安全组件暴露 审计方法： 通过查看配置文件 AndroidManifest.xml,查看属性有没有配置 false AndriodManifest.xml 文件中，代码 24 行处 activity 组件添加属性，没有配置 false, 默认组件可被导出<br><br>.1CSRF<br>审计方法:通过查看配置文件有没有配置 csrf 全局过滤器，如果没有则重点看每个操作前有<br>没有添加 token 的防护机制<br>在 Smpkpiappealcontroller.java 中 200 处，直接用用 ids 控制删除操作，而没有添加防<br>csrf 的随机 token 验证检查，存在 csrf 漏洞。<br><br>越权操作<br>审计方法：重点关注用户操作请求时查看是否有对当前登陆用户权限做校验从而确定是否存<br>在漏洞，有些厂商会使用一些主流的权限框架，例如 shiro ,spring security 等框架，那么需要<br>重点关注框架的配置文件以及实现方法<br><br>会话超时设置<br>审计方法：<br>Javaweb 应用会话超时设置一般有俩种方法：<br>一是在配置文件 web.xml 设置<br>二是通过 java 代码设置<br><br><br>敏感数据弱加密<br>审计方法：<br>敏感数据弱加密主要看数据传输中的加密方法，一般写在工具类 util 中以下文件中为 base64 编码方法<br><br>未授权 init dofilter destory @WebInitParam<br>yf-exam-lite\exam-api\src\main\java\com\yf\exam\config\ShiroConfig.java 查看是否有shiro配置不当的未授权<br><br></code></pre></td></tr></table></figure><p>application.yml可以找到框架包</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">网站路由<br>控制器（app<span class="hljs-regexp">/Http/</span>Controllers）<br>中间件（app<span class="hljs-regexp">/Http/</span>Middleware）<br>Model（app/Models）<br>网站配置（config）<br>第三方扩展（composer.json）<br></code></pre></td></tr></table></figure><p>usercontroller等各种controller中的getmapping都可以看一下存不存在缺少过滤</p><p>filename参数一般出现在Content-Dispostion：</p><p>一般sql查询都在service层</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">isAbsolute</span><span class="hljs-params">()</span></span> 判断抽象文件是不是绝对路径<br></code></pre></td></tr></table></figure><p>分析新的补丁去反向查找历史漏洞</p><p>幽灵代码</p><p>1.AOP</p><p>很多java漏洞的修复没有用到任何过滤，却被修复了 这就是java的幽灵代码 和AOP等有很大关系 多看一看这些注解代码<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071436206.png" srcset="/img/loading.gif" lazyload alt="image-20220607143601141"></p><p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1118">奇安信攻防社区-浅析JAVA代码审计中的“幽灵代码” (butian.net)</a></p><p>2.拦截器（Interceptor）<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071512538.png" srcset="/img/loading.gif" lazyload alt="image-20220607151242486"></p><p>跟进代码的话是看不到拦截的 跟进注释也没用</p><p>只能主动搜素Interceptor 或 addInterceptor<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD/202206071510841.png" srcset="/img/loading.gif" lazyload></p><p>然后找到拦截器 然后找到相似方法<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071512699.png" srcset="/img/loading.gif" lazyload alt="image-20220607151256643"></p><p>跟进找到拦截方法<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071513749.png" srcset="/img/loading.gif" lazyload alt="image-20220607151312690"></p><p>3.Fliter</p><p>先找前面两个 没找到就只能是这个了</p><p>到web.xml里面搜索filter<img src="https://cd-1307445315.cos.ap-nanjing.myqcloud.com/CD%5C202206071521926.png" srcset="/img/loading.gif" lazyload alt="image-20220607152104885"></p><p>下面那个表示只过滤secret</p><p>这种通用逻辑不仅可以处理权限类型的问题，也可以实现SQL注入、命令注入、XSS等各种漏洞关键字过滤。</p><p>1、在java安全开发中若需要用到对xml进行解析的话，应考虑xml组件默认有没有禁用外部实体引用或者其他安全问题，针对补充安全配置以防止功能点在引用到不安全的xml解析器的时候引发一系列的安全问题</p><p>有些安全人员开发了新的代码用了新的java版本后 没有向下顾虑java低版本的安全性 可能造成漏洞</p><p>Runtime是调用的ProcessBuilder<br>而ProcessBuilder是调用的ProcessImpl<br>所以上面三种方式本质都是调用ProcessImpl创建进程，命令执行</p><p>工控段有很多命令执行 一定要抓包改着都试一试</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">如果找到了不稳定的文件上传点，可以用一个文件包含来和上面这段代码中的 删除 操作进行竞争，在文件被删除之前包含它，来达到执行代码的效果(因为需要条件竞争，可以考虑把这个上传包放到 intruder 里重放个几百次，然后在上传的过程中，去尝试包含 <span class="hljs-regexp">/tmp/</span>TempClass.php ，来达到竞争的效果。)<br>https:<span class="hljs-regexp">//</span>xz.aliyun.com<span class="hljs-regexp">/t/</span><span class="hljs-number">9319</span><br>一旦包含成功，那么在实例化 TempClass 的时候，会写入一个新的 TempClass2，这下可没有代码会去 unlink(删除) 它了，可以被稳定的利用。<br></code></pre></td></tr></table></figure><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">在js找相关接口 上传的话就看有没有<span class="hljs-keyword">type</span>: <span class="hljs-symbol">&#x27;POST</span>&#x27;啥的<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">有的时候尝试访问之后发现这个上传接口不能随意访问，所以还得从程序入口开始审计哪里做了鉴权。鉴权的话找找hook类<br></code></pre></td></tr></table></figure><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">内省一个实际就是获取到这个<span class="hljs-keyword">Bean相关的所有方法</span><br><span class="hljs-keyword"></span><br></code></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">如果发现有反序列化漏洞的话（使用了低版本的<span class="hljs-keyword">cc</span>链）<br><br>直接找readobject<br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode">如果发现有lo<span class="hljs-name">g4</span>j的话（使用了低版本的lo<span class="hljs-name">g4</span>j链）、<br>寻找漏洞利用点，搜索有没有存在参数可控的 logger.error<br><br>只要参数可控 就算多重参数 选取其中一个可控的就行<br>即使参数加密 我们反加密就行<br></code></pre></td></tr></table></figure><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">上传漏洞下断点的位置<br>HttpServletRequest request <span class="hljs-operator">=</span> getRequest()<span class="hljs-comment">;有点Java知识的人都认识这个,所以第一个断点设置在这里。</span><br>第二个断点，审计的上传漏洞，肯定设置在上传方法里<br>比如： responsedata <span class="hljs-operator">=</span> fm.add()<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">先黑盒并抓包判断访问位置，然后白盒确定过滤和防护等并绕过<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">ssti模板注入 如framwork 注意检查大部分国产模板<br></code></pre></td></tr></table></figure><p>简单写个payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">我们且看第一行，按照上面给出简单案例方法，我们应该这样子就可以了<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,String.class).invoke(newInstance(),<span class="hljs-string">&quot;calc&quot;</span>)<br>但是直接String.class直接写模板是找不到的，所以我们得继续构造payload，将String.class转化<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.String&quot;</span>)的形式，然后payload就变成下面这样子了。<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.String&quot;</span>)).invoke(newInstance(),<span class="hljs-string">&quot;calc&quot;</span>)<br>照道理上面就可以直接使用了，但是呢Runtime类没有无参构造方法，因此不能使用newInstance()方法来实例化。只能通过调用getRuntime()方法来进行实例化。所以newInstance()得替换成<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>)最终payload就变成了下面这样子。<br>$&#123;<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.String&quot;</span>)).invoke(<span class="hljs-meta">@java</span>.lang.Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>).invoke(<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>),<span class="hljs-string">&quot;calc&quot;</span>)&#125;<br><br>遇到使用了模板的解析CMS可以根据模板解析语言尝试执行命令，若遇到函数警用的情况可以尝试一些Bypass方法，比例一些反射、反序列化、字节码修改等。SSTI注入难的其实如何构造Payload，构造好了之后一切自然而然了。<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">黑盒中f12网络的各个显示的链接 都可以点一下 长一点的链接优先，然后跟进白盒<br><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">前台随便审一下就行，主要是看下有没有权限，并记下记录，万一后面后台rce要用到<br>审的时候一个流程一个流程来 每个流程的小流程都写一下流程<br><br></code></pre></td></tr></table></figure><h2 id="内存码"><a href="#内存码" class="headerlink" title="内存码"></a>内存码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">Agent内存码篇<br>    <br>由于实际环境中我们通常遇到的都是已经启动着的，所以 premain 那种方法不合适内存马注入，所以我们这里利用 agentmain 方法来尝试注入我们的内存马<br>    <br>由于某些中间件（例如nginx）只记录GET请求，使用POST方式发送数据会更加隐蔽。<br><br>由于在Filter层过滤了http请求，访问任意的路由都可以执行恶意代码，为了隐蔽性不建议使用不存在的路由。<br><br>agent可以注入多个，但是相同类名的transformer只能注入一个，所以要再次注入别的agent的时候记得更改一下类名。<br><br>这种内存马一旦注入到目标程序中，除了重启没有办法直接卸载掉，因为修改掉了原本的类的字节码。<br><br>既然如此，那我再把它改回去不就得了嘛。这就是我为什么选择doFilter方法的原因——逻辑简单，方便还原。它的逻辑只是调用了internalDoFilter()方法（简单来说）。还原就只需要setBody()即可：<br><br>拓展、<br>当我们能够改变类的字节码，那能做的事情可多了去了，下面我提出两个例子，抛砖引玉。<br><br><span class="hljs-number">1.</span>路由劫持<br>再来假设这么一个情况：拿下来了站点A，同时其他的资产暂时没有更大的收获，需要使用其他方法来扩展攻击面。在A的/login中使用了/<span class="hljs-keyword">static</span>/js/<span class="hljs-number">1.</span>js，那就可以劫持这个路由，回显给他恶意的js代码。<br>实现的话，只需要在start.txt也就是即将插入的代码块中，判断一下当前访问的路由。<br><span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br><span class="hljs-keyword">if</span> (uri.equals(<span class="hljs-string">&quot;/static/js/1.js&quot;</span>)) &#123;<br>    response.getWriter().write([恶意js代码]);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br>那么当访问到/login的时候，浏览器发现引用了外部js——/<span class="hljs-keyword">static</span>/js/<span class="hljs-number">1.</span>js，就会去请求它，然而请求被我们修改后的ApplicationFilterChain#doFilter()拦截，返回了一个虚假的页面，导致资源被“替换”，恶意代码发挥作用。<br><br><span class="hljs-number">2.</span>替换shiro的key<br>    在解析rememberMe的时候，先将其base64解码，然后使用AES解密，在AES解密的时候，会调用org.apache.shiro.mgt.AbstractRememberMeManager#getDecryptionCipherKey()，更改掉这个函数的返回值，就可以更改解密的密钥。实现也很简单，只需要改掉上面的常量和start.txt即可：<br>    <br>    <br>还有就是之前看大哥们说过，在有的环境下agent内存马注入之后网站会崩掉，听他们说是有可能因为虚拟内存不够了而导致的，所以具体使用的话还是需要事先斟酌一下<br>还有就是关键类寻找不对等情况也有可能导致网站被打挂<br></code></pre></td></tr></table></figure><p>选中类按F4能够知道此类的长继承关系</p><h2 id="几个关于断点调试的小技巧"><a href="#几个关于断点调试的小技巧" class="headerlink" title="几个关于断点调试的小技巧"></a>几个关于断点调试的小技巧</h2><p>1.断点打上后右键断点:b:可以编辑 不如设置x&#x3D;50就能断点到x&#x3D;50之前所有的回显 不用自己手动一次一次放过</p><p>2.热重载 边断点调试边改代码</p><p>3.多线程往往执行都是无顺序的 因为是多线程 那么其中如果为了打断点只要回显一个线程的所有报文 应该打开调试-窗体-线程</p><p>就能看到所有线程，且每个线程会有对应的id 我们只需要右键断点编辑其中的筛选器设置“thread&#x3D;‘线程id’”</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/java-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="category-chain-item">java 代码审计</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">#学习笔记</a></div></div><div class="license-box my-3"><div class="license-title"><div>java代码审计小tips</div><div>http://example.com/java代码审计小tips.html</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>CDxiaodong</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>September 2, 2022</div></div><div class="license-meta-item"><div>Licensed under</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/ysos%E5%88%A9%E7%94%A8nc%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html" title="ysos nc反序列化RCE(去隐 防github)（CNVD-2022-70332）"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">ysos nc反序列化RCE(去隐 防github)（CNVD-2022-70332）</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/kali%E5%85%A8%E9%83%A8%E8%BD%AF%E4%BB%B6%E4%BB%8B%E7%BB%8D.html" title="kali全部软件介绍"><span class="hidden-mobile">kali全部软件介绍</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/cdxiaodong" target="_blank" rel="nofollow noopener"><span>CD</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/cdxiaodong" target="_blank" rel="nofollow noopener"><span>XD</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>